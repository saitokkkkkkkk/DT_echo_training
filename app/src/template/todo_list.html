<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .status {
            font-weight: bold;
            cursor: pointer; /* クリック可能なカーソルを追加 */
        }
        .status.done {
            color: blue; /* doneの時は青 */
        }
        .status.undone {
            color: red; /* undoneの時は赤 */
        }

        .highlight {
            background-color: lightgray; /* 薄いグレー色 */
            transition: background-color 0.3s ease; /* なめらかな変化 */
        }
    </style>

</head>
<body>
<div class="container mt-5">
    <div class="d-flex align-items-center mb-3">
        <h3 class="mr-auto"> Your Todos </h3>
        <div>
            <a href="/todos/new" class="btn btn-primary">Add new todo</a>
        </div>
    </div>

    <!--セッションにメッセージが存在している時-->
    {{if .Message}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{.Message}}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {{end}}

    <!-- todoがある場合 -->
    {{ if .Todos }}

    <!-- undoneのTodo -->
    <ul class="list-group mb-4">
        {{ range .Todos }}
        {{ if not .CompletedDate }}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="/todos/{{ .ID }}">{{ .Title }}</a>
            <span class="status undone" data-id="{{ .ID }}" data-status="undone" onclick="toggleStatus(this)">undone</span>
            <div class="status-options" style="display: none;">
                <span class="status-option" onclick="updateStatus('{{ .ID }}', 'done')">done</span> |
                <span class="status-option" onclick="updateStatus('{{ .ID }}', 'undone')">undone</span>
            </div>
        </li>
        {{ end }}
        {{ end }}
    </ul>

    <!-- doneのTodo -->
    <ul class="list-group">
        {{ $hasCompleted := false }}
        {{ range .Todos }}
        {{ if .CompletedDate }}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="/todos/{{ .ID }}">{{ .Title }}</a>
            <span class="status done" data-id="{{ .ID }}" data-status="done" onclick="toggleStatus(this)">done</span>
            <div class="status-options" style="display: none;">
                <span class="status-option" onclick="updateStatus('{{ .ID }}', 'done')">done</span> |
                <span class="status-option" onclick="updateStatus('{{ .ID }}', 'undone')">undone</span>
            </div>
            {{ $hasCompleted = true }}
        </li>
        {{ end }}
        {{ end }}
    </ul>

    <!--ajaxではない時の一括削除ボタン-->
    {{ if .HasCompleted }}
    <div class="text-right my-2 d-flex justify-content-end">
        <form action="/todos/bulk-delete" method="POST" style="display: inline;" class="bulk-delete-form">
            <button type="submit" class="btn btn-link text-secondary small bulk-delete-button" style="text-decoration: none;" onclick="confirmBulkDelete(event)">
                ✖︎ Delete All Done
            </button>
        </form>
    </div>
    {{ end }}

    <!--ajaxの時の一括削除ボタン-->
    <div class="text-right my-2 d-flex justify-content-end">
        <form action="/todos/bulk-delete" method="POST" style="display: inline;" class="bulk-delete-form">
            <button type="submit" class="btn btn-link text-secondary small bulk-delete-button" style="text-decoration: none; display: none;" onclick="confirmBulkDelete(event)">
                ✖︎ Delete All Done
            </button>
        </form>
    </div>

    <!-- todoがない場合 -->
    {{ else }}
    <ul class="list-group">
        <li class="list-group-item">No todos available.</li>
    </ul>
    ￼
    {{ end }}
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>

    // ステータス変更の処理
    function toggleStatus(element) {
        //todoのidと変更後のステータスを先に取得
        const todoId = element.getAttribute('data-id');
        const currentStatus = element.getAttribute('data-status');
        const newStatus = currentStatus === 'done' ? 'undone' : 'done';

        // リクエストの送信
        fetch(`/todos/${todoId}/status`, {
            method: 'PUT',
            //リクエストボディがjsonであるということ
            headers: {
                'Content-Type': 'application/json',
            },
            // 上の情報を詳細化。変更後のステータスをjson形式で持つ。
            body: JSON.stringify({ status: newStatus })
        })
            .then(response => {
                if (!response.ok) { //レスポンスが200系でない時にtrue
                    throw new Error('Network response was not ok');
                }
                // 受け取ったjsonをjsで使用可能に。
                return response.json();
            })
            .then(data => {
                // コントローラから返却されてくるキーokがtrueの時
                if (data.ok) {
                    // ステータスの表示を更新（elementはspanタグ）
                    element.innerText = newStatus;
                    element.setAttribute('data-status', newStatus);

                    const todoItem = element.parentElement;
                    const doneList = document.querySelector('.list-group:last-of-type');
                    const undoneList = document.querySelector('.list-group.mb-4');

                    //element.classListでspanタグのクラスの操作、新しい状態のレコードを画面に挿入
                    if (newStatus === 'done') {
                        element.classList.remove('undone');
                        element.classList.add('done');
                        //insertBeforeで、変更したレコードをdoneの最上部に移動
                        doneList.insertBefore(todoItem, doneList.firstChild);
                    } else {
                        element.classList.remove('done');
                        element.classList.add('undone');
                        //appendChildで、変更したレコードをundoneの最下部に移動
                        undoneList.appendChild(todoItem);
                    }

                    // ステータス変更されたアイテムにハイライトクラスを追加
                    todoItem.classList.add('highlight');
                    setTimeout(() => {
                        todoItem.classList.remove('highlight'); // 1秒後にクラスを削除
                    }, 1000);

                    // 一括削除ボタンの表示を更新
                    updateBulkDeleteButton(data.hasCompleted);
                } else {
                    alert('ステータスの更新に失敗しました');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 一括削除ボタンの表示、非表示
    function updateBulkDeleteButton(hasCompleted) {
        // 画面から一括削除ボタンを取得（取得しないといけない ⇨ if文だとdomから削除してしまって取得できないから、cssのdisplay: none; を使用）
        const bulkDeleteButton = document.querySelector('.bulk-delete-button');

        if (hasCompleted) {
            bulkDeleteButton.style.display = 'block'; // ボタンを表示
        } else {
            bulkDeleteButton.style.display = 'none'; // ボタンを非表示
        }
    }

    //一括削除のconfirm
    function confirmBulkDelete(event) {
        event.preventDefault(); // デフォルトのフォーム送信を防ぐ

        // 確認ボックスを表示
        const confirmed = confirm('Are you sure you want to delete all completed tasks?');

        if (confirmed) {
            // ユーザーがOKを押した場合、親フォームを送信
            const form = event.target.closest('form'); // ボタンが属するフォームを取得
            form.submit();
        }
    }

</script>

</body>
</html>